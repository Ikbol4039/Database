Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Ikbol Allakhunov> psql -U postgres
Password for user postgres:

psql (17.5)
WARNING: Console code page (437) differs from Windows code page (1252)
         8-bit characters might not work correctly. See psql reference
         page "Notes for Windows users" for details.
Type "help" for help.

postgres=# DROP TABLE IF EXISTS order_items CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS inventory CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS products CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS accounts CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS logs CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS users CASCADE;
NOTICE:  drop cascades to constraint user_preferences_user_id_fkey on table user_preferences
DROP TABLE
postgres=# DROP TABLE IF EXISTS audit_log CASCADE;
DROP TABLE
postgres=# DROP TABLE IF EXISTS user_preferences CASCADE;
DROP TABLE
postgres=#
postgres=# CREATE TABLE accounts (
postgres(#   account_id SERIAL PRIMARY KEY,
postgres(#   owner TEXT NOT NULL,
postgres(#   balance NUMERIC(14,2) NOT NULL CHECK (balance >= 0)
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE customers (
postgres(#   customer_id SERIAL PRIMARY KEY,
postgres(#   name TEXT NOT NULL,
postgres(#   email TEXT UNIQUE
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE products (
postgres(#   product_id SERIAL PRIMARY KEY,
postgres(#   name TEXT NOT NULL,
postgres(#   price NUMERIC(10,2) NOT NULL CHECK (price >= 0)
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE inventory (
postgres(#   product_id INT PRIMARY KEY REFERENCES products(product_id),
postgres(#   stock INT NOT NULL CHECK (stock >= 0)
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE orders (
postgres(#   order_id SERIAL PRIMARY KEY,
postgres(#   customer_id INT REFERENCES customers(customer_id),
postgres(#   total NUMERIC(12,2) NOT NULL DEFAULT 0,
postgres(#   created_at TIMESTAMP DEFAULT NOW()
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE order_items (
postgres(#   order_item_id SERIAL PRIMARY KEY,
postgres(#   order_id INT REFERENCES orders(order_id) ON DELETE CASCADE,
postgres(#   product_id INT REFERENCES products(product_id),
postgres(#   quantity INT NOT NULL CHECK (quantity > 0),
postgres(#   item_price NUMERIC(10,2) NOT NULL
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE logs (
postgres(#   log_id SERIAL PRIMARY KEY,
postgres(#   message TEXT,
postgres(#   created_at TIMESTAMP DEFAULT NOW()
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE users (
postgres(#   user_id SERIAL PRIMARY KEY,
postgres(#   name TEXT NOT NULL,
postgres(#   email TEXT UNIQUE
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE user_preferences (
postgres(#   pref_id SERIAL PRIMARY KEY,
postgres(#   user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
postgres(#   theme TEXT
postgres(# );
CREATE TABLE
postgres=#
postgres=# CREATE TABLE audit_log (
postgres(#   audit_id SERIAL PRIMARY KEY,
postgres(#   action TEXT,
postgres(#   ts TIMESTAMP DEFAULT NOW()
postgres(# );
CREATE TABLE
postgres=#
postgres=# INSERT INTO accounts(owner,balance) VALUES
postgres-# ('Alice', 1000.00),
postgres-# ('Bob', 500.00),
postgres-# ('Charlie', 50.00);
INSERT 0 3
postgres=#
postgres=# INSERT INTO customers(name,email) VALUES
postgres-# ('Company A','a@example.com'),
postgres-# ('Company B','b@example.com');
INSERT 0 2
postgres=#
postgres=# INSERT INTO products(name,price) VALUES
postgres-# ('Laptop',999.99),
postgres-# ('Mouse',25.99),
postgres-# ('Keyboard',79.99);
INSERT 0 3
postgres=#
postgres=# INSERT INTO inventory(product_id,stock) VALUES
postgres-# (1,10),
postgres-# (2,50),
postgres-# (3,20);
INSERT 0 3
postgres=#
postgres=# INSERT INTO users(name,email) VALUES
postgres-# ('Admin','admin@example.com');
INSERT 0 1
postgres=#
postgres=# INSERT INTO user_preferences(user_id,theme) VALUES
postgres-# (1,'dark');
INSERT 0 1
postgres=#
postgres=# INSERT INTO logs(message) VALUES
postgres-# ('Setup complete');
INSERT 0 1
postgres=#
postgres=# INSERT INTO audit_log(action) VALUES
postgres-# ('init');
INSERT 0 1
postgres=#
postgres=# BEGIN;
BEGIN
postgres=*# WITH new_order AS (
postgres(*#   INSERT INTO orders(customer_id,total)
postgres(*#   VALUES (1,0)
postgres(*#   RETURNING order_id
postgres(*# )
postgres-*# INSERT INTO order_items(order_id,product_id,quantity,item_price)
postgres-*# SELECT order_id, 1, 1, (SELECT price FROM products WHERE product_id=1)
postgres-*# FROM new_order;
INSERT 0 1
postgres=*# UPDATE orders
postgres-*# SET total = (SELECT SUM(quantity*item_price) FROM order_items WHERE order_id = orders.order_id)
postgres-*# WHERE order_id = (SELECT order_id FROM orders ORDER BY order_id DESC LIMIT 1);
UPDATE 1
postgres=*# COMMIT;
COMMIT
postgres=#
postgres=# DO $$
postgres$# DECLARE
postgres$#   bal NUMERIC(14,2);
postgres$# BEGIN
postgres$#   SELECT balance INTO bal FROM accounts WHERE account_id = 1 FOR UPDATE;
postgres$#   IF bal < 200 THEN
postgres$#     RAISE EXCEPTION 'insufficient funds';
postgres$#   END IF;
postgres$#   UPDATE accounts SET balance = balance - 200 WHERE account_id = 1;
postgres$#   UPDATE accounts SET balance = balance + 200 WHERE account_id = 2;
postgres$#   INSERT INTO audit_log(action) VALUES ('transfer 200 from 1 to 2');
postgres$# END
postgres$# $$;
DO
postgres=#
postgres=# DO $$
postgres$# DECLARE
postgres$#   bal NUMERIC(14,2);
postgres$# BEGIN
postgres$#   SELECT balance INTO bal FROM accounts WHERE account_id = 3 FOR UPDATE;
postgres$#   IF bal < 100 THEN
postgres$#     RAISE EXCEPTION 'insufficient funds';
postgres$#   END IF;
postgres$#   UPDATE accounts SET balance = balance - 100 WHERE account_id = 3;
postgres$#   UPDATE accounts SET balance = balance + 1 WHERE account_id = 2;
postgres$#   INSERT INTO audit_log(action) VALUES ('transfer 100 from 3 to 2');
postgres$# END
postgres$# $$;
ERROR:  insufficient funds
CONTEXT:  PL/pgSQL function inline_code_block line 7 at RAISE
postgres=#
postgres=# BEGIN;
BEGIN
postgres=*# INSERT INTO customers(name,email) VALUES ('Bob Customer','bobcust@example.com');
INSERT 0 1
postgres=*# SAVEPOINT sp_after_customer;
SAVEPOINT
postgres=*# INSERT INTO products(name,price) VALUES ('InvalidProduct', -10.00);
ERROR:  new row for relation "products" violates check constraint "products_price_check"
DETAIL:  Failing row contains (4, InvalidProduct, -10.00).
postgres=!# ROLLBACK TO SAVEPOINT sp_after_customer;
ROLLBACK
postgres=*# INSERT INTO products(name,price) VALUES ('ValidAccessory', 19.99);
INSERT 0 1
postgres=*# RELEASE SAVEPOINT sp_after_customer;
RELEASE
postgres=*# COMMIT;
COMMIT
postgres=#
postgres=# BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN
postgres=*# SELECT account_id, balance FROM accounts WHERE account_id IN (1,2);
 account_id | balance
------------+---------
          1 |  800.00
          2 |  700.00
(2 rows)


postgres=*# COMMIT;
COMMIT
postgres=#
postgres=# BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN
postgres=*# SELECT account_id, balance FROM accounts WHERE account_id = 1 FOR UPDATE;
 account_id | balance
------------+---------
          1 |  800.00
(1 row)


postgres=*# UPDATE accounts SET balance = balance * 1.01 WHERE account_id = 1;
UPDATE 1
postgres=*# COMMIT;
COMMIT
postgres=#
postgres=# BEGIN;
BEGIN
postgres=*# SAVEPOINT before_order_items;
SAVEPOINT
postgres=*# WITH new_order2 AS (
postgres(*#   INSERT INTO orders(customer_id,total)
postgres(*#   VALUES (2,0)
postgres(*#   RETURNING order_id
postgres(*# )
postgres-*# INSERT INTO order_items(order_id,product_id,quantity,item_price)
postgres-*# SELECT order_id, 2, 2, (SELECT price FROM products WHERE product_id=2)
postgres-*# FROM new_order2;
INSERT 0 1
postgres=*# ROLLBACK TO SAVEPOINT before_order_items;
ROLLBACK
postgres=*# WITH order_ref AS (
postgres(*#   SELECT order_id FROM orders ORDER BY order_id DESC LIMIT 1
postgres(*# )
postgres-*# INSERT INTO order_items(order_id,product_id,quantity,item_price)
postgres-*# SELECT order_id, 3, 1, (SELECT price FROM products WHERE product_id=3)
postgres-*# FROM order_ref;
INSERT 0 1
postgres=*# UPDATE orders
postgres-*# SET total = (SELECT SUM(quantity*item_price) FROM order_items WHERE order_id = orders.order_id)
postgres-*# WHERE order_id = (SELECT order_id FROM orders ORDER BY order_id DESC LIMIT 1);
UPDATE 1
postgres=*# COMMIT;
COMMIT
postgres=#
postgres=# SELECT
postgres-#   blocked_locks.pid AS blocked_pid,
postgres-#   blocked_activity.usename AS blocked_user,
postgres-#   blocking_locks.pid AS blocking_pid,
postgres-#   blocking_activity.usename AS blocking_user,
postgres-#   blocked_activity.query AS blocked_statement
postgres-# FROM pg_catalog.pg_locks blocked_locks
postgres-# JOIN pg_catalog.pg_stat_activity blocked_activity
postgres-#   ON blocked_activity.pid = blocked_locks.pid
postgres-# JOIN pg_catalog.pg_locks blocking_locks
postgres-#   ON blocking_locks.locktype = blocked_locks.locktype
postgres-# JOIN pg_catalog.pg_stat_activity blocking_activity
postgres-#   ON blocking_activity.pid = blocking_locks.pid
postgres-# WHERE NOT blocked_locks.granted;
 blocked_pid | blocked_user | blocking_pid | blocking_user | blocked_statement
-------------+--------------+--------------+---------------+-------------------
(0 rows)


postgres=#
postgres=# BEGIN;
BEGIN
postgres=*# INSERT INTO logs(message) VALUES ('Start long operation');
INSERT 0 1
postgres=*# SAVEPOINT sp_long;
SAVEPOINT
postgres=*# INSERT INTO logs(message) VALUES ('Checkpoint reached');
INSERT 0 1
postgres=*# RELEASE SAVEPOINT sp_long;
RELEASE
postgres=*# COMMIT;
COMMIT
postgres=#
